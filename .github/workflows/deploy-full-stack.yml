name: Deploy Full Stack Application

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Full Stack to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 212.8.227.80
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        command_timeout: 30m
        timeout: 30m
        script: |
          echo "ðŸš€ Starting full stack deployment..."
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          apt update
          apt install -y curl git wget software-properties-common apt-transport-https ca-certificates gnupg lsb-release
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v docker &> /dev/null; then
            echo "ðŸ³ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            rm get-docker.sh
          fi
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ™ Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐº Docker ÐµÑÐ»Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
          systemctl start docker
          systemctl enable docker
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          mkdir -p /var/www
          cd /var/www
          
          # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
          if [ -d "dshina" ]; then
            cd dshina
            docker-compose down 2>/dev/null || true
            docker system prune -f
            cd ..
          fi
          
          # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¸ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹
          rm -rf dshina
          git clone ${{ github.server_url }}/${{ github.repository }}.git dshina
          cd dshina
          
          # ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
          git checkout ${{ github.ref_name }}
          
          echo "ðŸ“ Creating environment files..."
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Docker Compose (ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹)
          cat > .env << 'EOF'
          # Variables for docker-compose.yml
          BASE_URL=${{ secrets.BASE_URL }}
          LOGIN=${{ secrets.LOGIN }}
          PASSWORD=${{ secrets.PASSWORD }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          NEXT_PUBLIC_BASE_URL=http://212.8.227.80/api
          NEXT_PUBLIC_BASE_URL_TELEGRAMSEND=${{ secrets.NEXT_PUBLIC_BASE_URL_TELEGRAMSEND }}
          EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Backend
          cat > dshina-back/.env << 'EOF'
          NODE_ENV=production
          PORT=4000
          BASE_URL=${{ secrets.BASE_URL }}
          LOGIN=${{ secrets.LOGIN }}
          PASSWORD=${{ secrets.PASSWORD }}
          EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Frontend
          cat > dshinaFront/.env << 'EOF'
          NODE_ENV=production
          NEXT_PUBLIC_BASE_URL=http://212.8.227.80/api
          NEXT_PUBLIC_BASE_URL_TELEGRAMSEND=${{ secrets.NEXT_PUBLIC_BASE_URL_TELEGRAMSEND }}
          EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Telegram Bot
          cat > telegram-bot/.env << 'EOF'
          NODE_ENV=production
          PORT=3001
          BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          EOF
          
          echo "ðŸ—ï¸ Building and starting all services..."
          
          # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· Docker Compose
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "â³ Waiting for services to start..."
          sleep 60
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          echo "ðŸ“Š Services status:"
          docker-compose ps
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
          echo "ðŸ“‹ Recent logs:"
          docker-compose logs --tail=10 backend
          docker-compose logs --tail=10 frontend
          docker-compose logs --tail=10 telegram-bot
          
          echo "âœ… Full stack deployment completed!"
          echo ""
          echo "ðŸŒ Services are accessible at:"
          echo "  - Frontend: http://212.8.227.80:3000"
          echo "  - Backend API: http://212.8.227.80:4000"  
          echo "  - Telegram Bot: http://212.8.227.80:3001"
          echo "  - Nginx Proxy: http://212.8.227.80 (if enabled)"
          echo ""
          echo "ðŸ”§ To check services status: docker-compose ps"
          echo "ðŸ“‹ To view logs: docker-compose logs [service-name]"