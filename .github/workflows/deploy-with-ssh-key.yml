name: Deploy Full Stack with SSH Key

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 212.8.227.80 >> ~/.ssh/known_hosts
      
    - name: Deploy Full Stack to Server
      run: |
        ssh -i ~/.ssh/id_rsa root@212.8.227.80 << 'EOF'
          echo "ðŸš€ Starting full stack deployment..."
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          apt update
          apt install -y curl git wget software-properties-common apt-transport-https ca-certificates gnupg lsb-release
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v docker &> /dev/null; then
            echo "ðŸ³ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            rm get-docker.sh
          fi
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ™ Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐº Docker
          systemctl start docker
          systemctl enable docker
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          mkdir -p /var/www
          cd /var/www
          
          # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          if [ -d "dshina" ]; then
            cd dshina
            docker-compose down 2>/dev/null || true
            docker system prune -f
            cd ..
          fi
          
          # ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          rm -rf dshina
          git clone ${{ github.server_url }}/${{ github.repository }}.git dshina
          cd dshina
          git checkout ${{ github.ref_name }}
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
          cat > .env << 'EOL'
          NODE_ENV=production
          PORT=4000
          NEXT_PUBLIC_BASE_URL=http://212.8.227.80:4000
          BOT_TOKEN=your-telegram-bot-token
          CHAT_ID=your-telegram-chat-id
          EOL
          
          echo "ðŸ—ï¸ Building and starting services..."
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "â³ Waiting for services..."
          sleep 60
          
          echo "ðŸ“Š Services status:"
          docker-compose ps
          
          echo "âœ… Deployment completed!"
          echo "Frontend: http://212.8.227.80:3000"
          echo "Backend: http://212.8.227.80:4000"
        EOF